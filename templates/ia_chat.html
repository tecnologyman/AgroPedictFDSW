{% extends "base.html" %}
{% load static %}

{% block title %}Asistente IA{% endblock %}

{% block content %}
<style>
/* ===== Asistente IA - versiÃ³n modernizada AgroPredict ===== */
.ia-wrap { display:flex; flex-direction:column; gap:16px; }
.ia-card {
  background: #fff;
  border: 1px solid #e4e4e7;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}
.ia-header {
  padding: 16px 20px;
  border-bottom: 1px solid #e4e4e7;
  background: linear-gradient(135deg, #5223ff, #7d5aff, #f78bc9);
  color: white;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}
.ia-badge {
  margin-left: auto;
  font-size: 12px;
  background: rgba(255,255,255,0.25);
  padding: 3px 10px;
  border-radius: 999px;
  font-weight: 500;
}
.ia-msgs {
  height: 60vh;
  overflow-y: auto;
  padding: 16px;
  background: #fafaff;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.ia-bubble {
  padding: 12px 14px;
  border-radius: 12px;
  white-space: pre-wrap;
  max-width: 78%;
  font-size: 15px;
  line-height: 1.4;
  transition: all 0.3s ease;
}
.ia-bubble.ia {
  align-self: flex-start;
  background: #f1f0ff;
  border-left: 4px solid #7b65f2;
}
.ia-bubble.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #5223ff, #7d5aff);
  color: white;
  border: none;
}
.ia-bubble.user:hover {
  background: linear-gradient(135deg, #6c44ff, #9c7cff);
}
.ia-composer {
  display:flex; gap:10px;
  padding:14px; border-top:1px solid #e4e4e7;
  background: #f9f9fb;
}
.ia-input {
  flex:1;
  padding:12px;
  border:1px solid #d1d5db;
  border-radius:10px;
  font-size:15px;
  outline:none;
  transition:border 0.2s ease, box-shadow 0.2s ease;
}
.ia-input:focus {
  border-color:#7b65f2;
  box-shadow: 0 0 0 3px rgba(123,101,242,0.15);
}
.ia-btn {
  padding:0 18px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#5223ff,#7d5aff,#f78bc9);
  color:#fff; font-weight:600;
  cursor:pointer;
  transition:all 0.25s ease;
}
.ia-btn:hover { transform:translateY(-1px); opacity:0.95; }
.ia-typing {
  align-self:flex-start;
  background:#f1f0ff;
  border-left:3px solid #7b65f2;
  padding:8px 12px;
  border-radius:12px;
  font-size:13px;
  color:#6b7280;
}
</style>

<div class="page-header">
  <h2>ðŸ¤– Asistente IA</h2>
  <p class="text-muted">Haz tus consultas al asistente directamente desde aquÃ­.</p>
</div>

<div class="ia-wrap">
  <div class="ia-card">
    <div class="ia-header">
      <strong>Asistente IA</strong>
      <span class="ia-badge">BETA</span>
    </div>

    <div id="ia-msgs" class="ia-msgs">
      <div class="ia-bubble ia">
        Â¡Hola! ðŸ‘‹ Soy tu asistente IA. Â¿En quÃ© te puedo ayudar hoy?
        <div style="font-size:12px; color:#6b7280; margin-top:6px;">IA â€¢ listo</div>
      </div>
    </div>

    <div id="ia-alert" class="ia-alert"></div>

    <div class="ia-composer">
      <input id="ia-q" type="text" class="ia-input" placeholder="Escribe tu preguntaâ€¦ (Enter para enviar)" autocomplete="off">
      <button id="ia-send" type="button" class="ia-btn">Enviar</button>
    </div>
  </div>
</div>

<script>
(function(){
  // Elementos
  const msgs  = document.getElementById("ia-msgs");
  const input = document.getElementById("ia-q");
  const send  = document.getElementById("ia-send");
  const alert = document.getElementById("ia-alert");

  // Helpers UI
  function addBubble(text, who){
    const div = document.createElement("div");
    div.className = "ia-bubble " + (who || "ia");
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return div;
  }
  function setAlert(text, type){ // "ok" | "err" | ""
    alert.className = "ia-alert" + (type ? " " + type : "");
    alert.textContent = text || "";
    alert.style.display = text ? "block" : "none";
  }
  let typingEl = null;
  function typing(show){
    if (show){
      if (typingEl) return;
      typingEl = document.createElement("div");
      typingEl.className = "ia-typing";
      typingEl.textContent = "La IA estÃ¡ escribiendoâ€¦";
      msgs.appendChild(typingEl);
      msgs.scrollTop = msgs.scrollHeight;
    } else if (typingEl){
      typingEl.remove();
      typingEl = null;
    }
  }

  // AcciÃ³n principal
  async function consultarIA(){
    const q = (input.value || "").trim();
    if (!q) return;

    setAlert("", "");
    addBubble(q, "user");
    input.value = "";
    send.disabled = true;
    typing(true);

    try {
      const resp = await fetch("{% url 'ia_consulta' %}?q=" + encodeURIComponent(q), { credentials: "same-origin" });
      const data = await resp.json();
      typing(false);

      if (!resp.ok) {
        addBubble(data.error || "OcurriÃ³ un error al consultar la IA.", "ia");
        setAlert("Error: " + (data.error || resp.statusText), "err");
      } else {
        addBubble(data.respuesta || "Sin respuesta.", "ia");
        setAlert("Listo âœ“", "ok");
      }
    } catch (e) {
      typing(false);
      addBubble("No se pudo contactar a la IA. Revisa tu conexiÃ³n.", "ia");
      setAlert("Error de red: " + e, "err");
    } finally {
      send.disabled = false;
      input.focus();
    }
  }

  // Eventos
  send.addEventListener("click", consultarIA);
  input.addEventListener("keydown", e => { if (e.key === "Enter") consultarIA(); });

  // Enfocar al cargar
  setTimeout(()=> input.focus(), 0);
})();
</script>
{% endblock %}
