{% extends 'base.html' %}
{% load static %}

{% block title %}Comparaci贸n de Predicciones - AgroPredict{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Comparaci贸n de Predicciones</h2>
    <p>Compare m煤ltiples predicciones para tomar mejores decisiones de inversi贸n</p>
</div>

<!-- Selector de predicciones -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card__body">
        <h4>Seleccionar Predicciones para Comparar</h4>
        <form method="get" style="margin-top: 1rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                {% for prediccion in todas_predicciones %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="predicciones" value="{{ prediccion.id }}" 
                               {% if prediccion.id|stringformat:"s" in prediccion_ids_selected %}checked{% endif %}
                               class="form-check-input">
                        <span class="checkbox-label">
                            {{ prediccion.tipo_arbol }} - {{ prediccion.comuna.nombre }}
                            <small>({{ prediccion.fecha_creacion|date:"d/m/Y" }})</small>
                            {% if prediccion.roi_proyectado %}
                                <span class="roi-badge roi-{{ prediccion.roi_proyectado|floatformat:0 }}">
                                    ROI: {{ prediccion.roi_proyectado|floatformat:1 }}%
                                </span>
                            {% endif %}
                        </span>
                    </label>
                {% endfor %}
            </div>
            <button type="submit" class="btn btn--primary">Comparar Seleccionadas</button>
        </form>
    </div>
</div>

{% if comparacion_data %}
<!-- Tabla de comparaci贸n -->
<div class="chart-section">
    <h3>Comparaci贸n Detallada</h3>
    <div class="comparison-table-container">
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Predicci贸n</th>
                    <th>Ubicaci贸n</th>
                    <th>Hect谩reas</th>
                    <th>Producci贸n<br><small>(ton/ha)</small></th>
                    <th>ROI Proyectado<br><small>(5 a帽os)</small></th>
                    <th>Inversi贸n<br><small>(CLP)</small></th>
                    <th>ROI por Ha<br><small>(%/ha)</small></th>
                    <th>Consumo Agua<br><small>(m鲁/ha)</small></th>
                    <th>Eficiencia<br><small>(ton/m鲁)</small></th>
                    <th>Riesgo</th>
                </tr>
            </thead>
            <tbody>
                {% for data in comparacion_data %}
                <tr>
                    <td class="prediccion-cell">
                        <strong>{{ data.prediccion.tipo_arbol }}</strong>
                        <small>ID: {{ data.prediccion.id }}</small>
                    </td>
                    <td>{{ data.prediccion.comuna.nombre }}<br><small>{{ data.prediccion.comuna.region.nombre }}</small></td>
                    <td>{{ data.prediccion.hectareas|floatformat:1 }}</td>
                    <td class="number-cell">{{ data.prediccion.produccion_por_hectarea|floatformat:2 }}</td>
                    <td class="roi-cell">
                        {% if data.prediccion.roi_proyectado %}
                            <span class="roi-value {% if data.prediccion.roi_proyectado >= 30 %}high-roi{% elif data.prediccion.roi_proyectado >= 15 %}medium-roi{% else %}low-roi{% endif %}">
                                {{ data.prediccion.roi_proyectado|floatformat:1 }}%
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="number-cell">
                        {% if data.prediccion.inversion_estimada %}
                            ${{ data.prediccion.inversion_estimada|floatformat:0 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="number-cell">{{ data.roi_por_hectarea|floatformat:1 }}%</td>
                    <td class="number-cell">{{ data.prediccion.consumo_agua_por_hectarea|floatformat:0|default:"-" }}</td>
                    <td class="number-cell">{{ data.eficiencia_agua|floatformat:4|default:"-" }}</td>
                    <td class="risk-cell">
                        <span class="risk-badge risk-{{ data.prediccion.get_rentabilidad_categoria|lower|cut:" " }}">
                            {{ data.prediccion.get_rentabilidad_categoria }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- An谩lisis comparativo -->
<div class="prediction-layout">
    <div class="form-section">
        <h3> An谩lisis Comparativo</h3>
        
        <div class="card">
            <div class="card__body">
                {% with mejor_roi=comparacion_data|first %}
                    {% for data in comparacion_data %}
                        {% if data.prediccion.roi_proyectado > mejor_roi.prediccion.roi_proyectado %}
                            {% with mejor_roi=data %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                
                    <div class="analysis-section">
                        <h5> Mejor Oportunidad de Inversi贸n</h5>
                        <p><strong>{{ mejor_roi.prediccion.tipo_arbol }}</strong> en {{ mejor_roi.prediccion.comuna.nombre }} 
                           con un ROI proyectado del <strong>{{ mejor_roi.prediccion.roi_proyectado|floatformat:1 }}%</strong></p>
                    </div>
                {% endwith %}
                
                <div class="analysis-section">
                    <h5> Comparaci贸n de Inversiones</h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        {% for data in comparacion_data %}
                            <div class="investment-summary">
                                <h6>{{ data.prediccion.tipo_arbol }}</h6>
                                <div class="investment-metrics">
                                    <div>Inversi贸n: ${{ data.prediccion.inversion_estimada|floatformat:0|default:"N/A" }}</div>
                                    <div>ROI/Ha: {{ data.roi_por_hectarea|floatformat:1 }}%</div>
                                    <div>Riesgo: {{ data.prediccion.get_rentabilidad_categoria }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h5> Eficiencia de Recursos</h5>
                    <p>An谩lisis del uso eficiente de agua y tierra para cada alternativa:</p>
                    <ul>
                        {% for data in comparacion_data %}
                            <li><strong>{{ data.prediccion.tipo_arbol }}:</strong> 
                                {{ data.eficiencia_agua|floatformat:4 }} toneladas por m鲁 de agua
                                ({{ data.prediccion.consumo_agua_por_hectarea|floatformat:0 }} m鲁/ha)</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-section">
        <h3> Recomendaciones</h3>
        
        <div class="card">
            <div class="card__body">
                <div class="recommendations">
                    {% for data in comparacion_data %}
                        <div class="recommendation-item">
                            <h5>{{ data.prediccion.tipo_arbol }} - {{ data.prediccion.comuna.nombre }}</h5>
                            {% if data.prediccion.roi_proyectado >= 30 %}
                                <div class="recommendation excellent">
                                    <strong>EXCELENTE:</strong> Alta rentabilidad, proceder con inversi贸n.
                                </div>
                            {% elif data.prediccion.roi_proyectado >= 15 %}
                                <div class="recommendation good">
                                    <strong>BUENA:</strong> Rentabilidad atractiva, evaluar riesgos.
                                </div>
                            {% elif data.prediccion.roi_proyectado >= 0 %}
                                <div class="recommendation moderate">
                                    <strong>MODERADA:</strong> Considerar optimizaciones.
                                </div>
                            {% else %}
                                <div class="recommendation poor">
                                    <strong>NO RECOMENDADA:</strong> Buscar alternativas.
                                </div>
                            {% endif %}
                            
                            <div class="recommendation-details">
                                <small>
                                    Inversi贸n: ${{ data.prediccion.inversion_estimada|floatformat:0|default:"N/A" }} | 
                                    ROI: {{ data.prediccion.roi_proyectado|floatformat:1|default:"N/A" }}% | 
                                    Confiabilidad: {{ data.prediccion.confiabilidad }}%
                                </small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Acciones adicionales -->
<div style="text-align: center; margin-top: 2rem;">
    <a href="{% url 'nueva_prediccion' %}" class="btn btn--primary btn--lg">Nueva Predicci贸n</a>
    <a href="{% url 'analisis_prediccion' %}" class="btn btn--secondary btn--lg">An谩lisis Detallado</a>
    <a href="{% url 'dashboard' %}" class="btn btn--secondary btn--lg">Dashboard</a>
</div>

{% else %}
<div class="card">
    <div class="card__body" style="text-align: center; padding: 3rem;">
        <h3>Seleccione predicciones para comparar</h3>
        <p>Elija entre 2 y 5 predicciones usando los checkboxes arriba para generar una comparaci贸n detallada.</p>
    </div>
</div>
{% endif %}

<style>
/* === COMPARACIN DE PREDICCIONES (AgroPredict UI) === */
body, .main-content { background: #f8f9fc !important; color: #222; }

/* Contenedor principal */
.chart-section, .form-section {
  background: #ffffff !important;
  border: 1px solid #e4e4e7;
  border-radius: 14px;
  padding: 1.8rem;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}
.chart-section:hover, .form-section:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.07);
}

/* Checkbox selector */
.checkbox-item {
  background: #fff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 10px;
  padding: 0.9rem;
  transition: all 0.25s ease;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.checkbox-item:hover {
  background: #f5f3ff !important;
  border-color: #7b65f2 !important;
  transform: translateY(-2px);
}
.checkbox-item input:checked + .checkbox-label {
  font-weight: 600;
  color: #4f46e5;
}

/* Tabla comparativa */
.comparison-table-container {
  overflow-x: auto;
  margin: 1rem 0;
  border-radius: 10px;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.comparison-table {
  width: 100%;
  border-collapse: collapse;
  color: #222;
}
.comparison-table thead {
  background: linear-gradient(135deg, #5223ff, #7d5aff, #f78bc9);
  color: #fff;
}
.comparison-table th, .comparison-table td {
  padding: 0.9rem;
  border: 1px solid #e5e7eb;
  text-align: center;
}
.comparison-table tr:nth-child(even) { background: #fafafa; }
.comparison-table tr:hover { background: #f2f5ff; }

/* Badges y ROI */
.roi-value {
  display: inline-block;
  font-weight: 600;
  padding: 0.25rem 0.6rem;
  border-radius: 8px;
  color: #fff !important;
}
.high-roi { background: #22c55e; }
.medium-roi { background: #eab308; color: #222 !important; }
.low-roi { background: #ef4444; }

/* Badges de riesgo */
.risk-badge {
  border-radius: 8px;
  padding: 0.3rem 0.6rem;
  font-weight: 600;
  color: #fff !important;
}
.risk-badge.risk-muyalta { background: #22c55e; }
.risk-badge.risk-alta { background: #facc15; color: #222 !important; }
.risk-badge.risk-media { background: #fde68a; color: #222 !important; }
.risk-badge.risk-baja, .risk-badge.risk-negativa { background: #ef4444; }

/* Recomendaciones */
.recommendation-item {
  background: #fff;
  border: 1px solid #eaeaea;
  border-radius: 10px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  transition: all 0.3s ease;
}
.recommendation-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.recommendation.excellent { background: rgba(34,197,94,0.08); border-left: 4px solid #22c55e; }
.recommendation.good { background: rgba(234,179,8,0.08); border-left: 4px solid #eab308; }
.recommendation.moderate { background: rgba(168,162,158,0.08); border-left: 4px solid #9ca3af; }
.recommendation.poor { background: rgba(239,68,68,0.08); border-left: 4px solid #ef4444; }

/* Botones */
.btn--primary {
  background: linear-gradient(135deg, #5223ff, #7d5aff, #f78bc9);
  color: #fff !important;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
}
.btn--primary:hover {
  background: linear-gradient(135deg, #6b47ff, #8e70ff, #f997cf);
  transform: translateY(-2px);
}
.btn--secondary {
  background: #f8f9fb;
  border: 1px solid #d4d4d8;
  color: #333;
  border-radius: 8px;
  font-weight: 500;
}
.btn--secondary:hover {
  background: #ececff;
  color: #4f46e5;
}

</style>
{% endblock %}