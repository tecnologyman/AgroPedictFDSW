{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Predicci√≥n - AgroPredict{% endblock %}

{% block extra_css %}
<style>
 /* === NUEVA PREDICCI√ìN ‚Äì AGROPREDICT UI === */

/* Fondo general */
body, .main-content {
  background: #f8f9fc !important;
  color: #222;
}

/* Animaciones */
@keyframes fadeInLeft {
  from { opacity: 0; transform: translateX(-30px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes slideInUp {
  from { opacity: 0; transform: translateY(40px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideInDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in-left { animation: fadeInLeft 0.5s ease-out forwards; opacity: 0; }
.animate-slide-in-up { animation: slideInUp 0.6s ease-out forwards; opacity: 0; }
.animate-slide-in-down { animation: slideInDown 0.5s ease-out forwards; opacity: 0; }

.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }
.delay-4 { animation-delay: 0.4s; }
.delay-5 { animation-delay: 0.5s; }
.delay-6 { animation-delay: 0.6s; }
.delay-7 { animation-delay: 0.7s; }
.delay-8 { animation-delay: 0.8s; }

/* Contenedor general */
.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 1rem 1.5rem 3rem 1.5rem;
}

/* Encabezado */
.form-header {
  text-align: left;
  margin-bottom: 2rem;
}
.form-header h1 {
  font-weight: 700;
  color: #1e1b4b;
  margin-bottom: 0.4rem;
}
.form-header .subtitle {
  color: #6b7280;
  font-size: 1rem;
}

/* Info Box */
.info-box {
  background: linear-gradient(135deg, rgba(125, 90, 255, 0.1), rgba(247, 139, 201, 0.15));
  border-left: 4px solid #7d5aff;
  padding: 1.5rem;
  border-radius: 10px;
  margin-bottom: 2rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.info-box h3 {
  margin-bottom: 0.5rem;
  color: #5223ff;
}
.info-box ul {
  margin-top: 0.5rem;
  padding-left: 1.2rem;
  color: #444;
}

/* Secciones del formulario */
.form-section {
  background: #ffffff;
  border: 1px solid #e4e4e7;
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 1.8rem;
  box-shadow: 0 3px 10px rgba(0,0,0,0.04);
  transition: all 0.3s ease;
}
.form-section:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 18px rgba(0,0,0,0.08);
}
.form-section h2 {
  font-size: 1.2rem;
  font-weight: 600;
  color: #4f46e5;
  margin-bottom: 1.5rem;
  padding-bottom: 0.6rem;
  border-bottom: 2px solid rgba(125, 90, 255, 0.4);
}

/* Campos de formulario */
.form-group {
  margin-bottom: 1.5rem;
  transition: transform 0.3s ease;
}
.form-group:hover { transform: translateX(5px); }

label {
  display: block;
  font-weight: 500;
  color: #374151;
  margin-bottom: 0.5rem;
}

input, select, textarea {
  width: 100%;
  padding: 0.7rem 0.9rem;
  font-size: 1rem;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background: #fff;
  transition: all 0.25s ease;
  outline: none;
}
input:focus, select:focus, textarea:focus {
  border-color: #7d5aff;
  box-shadow: 0 0 0 3px rgba(125, 90, 255, 0.15);
}
.form-error {
  margin-top: 0.4rem;
  color: #ef4444;
  font-size: 0.9rem;
}

/* Botones */
.btn-primary {
  background: linear-gradient(135deg, #5223ff, #7d5aff, #f78bc9);
  border: none;
  color: #fff;
  font-weight: 600;
  padding: 0.8rem 1.6rem;
  border-radius: 8px;
  transition: all 0.3s ease;
}
.btn-primary:hover {
  background: linear-gradient(135deg, #6b47ff, #8d70ff, #f997cf);
  transform: translateY(-2px);
}
.btn-secondary {
  background: #f3f4f6;
  border: 1px solid #d4d4d8;
  color: #333;
  font-weight: 500;
  padding: 0.8rem 1.6rem;
  border-radius: 8px;
  transition: all 0.3s ease;
}
.btn-secondary:hover {
  background: #ede9fe;
  color: #4f46e5;
}

/* Contenedor de botones */
.form-actions {
  display: flex;
  justify-content: center;
  gap: 1.2rem;
  margin-top: 2rem;
}

/* Validaci√≥n */
.was-validated input:invalid {
  border-color: #ef4444;
}
.was-validated input:invalid:focus {
  box-shadow: 0 0 0 3px rgba(239,68,68,0.15);
}

/* Peque√±as mejoras visuales */
button:focus-visible {
  outline: 2px solid #7d5aff;
  outline-offset: 3px;
}

</style>
{% endblock %}

{% block content %}

<div class="container">

  <!-- Encabezado -->
  <div class="form-header animate-slide-in-down">
    <h1>Nueva Predicci√≥n</h1>
    <p class="subtitle">Complete los datos para generar una predicci√≥n de producci√≥n agr√≠cola</p>
  </div>

  <!-- Informaci√≥n del sistema -->
  <div class="info-box animate-fade-in-left delay-1">
    <h3>¬øC√≥mo funciona?</h3>
    <p>Nuestro sistema utiliza algoritmos de aprendizaje autom√°tico para predecir la producci√≥n agr√≠cola bas√°ndose en:</p>
    <ul class="info-list">
      <li><strong>Tipo de cultivo:</strong> Cada √°rbol tiene caracter√≠sticas espec√≠ficas de rendimiento</li>
      <li><strong>Condiciones geogr√°ficas:</strong> Clima y ubicaci√≥n regional</li>
      <li><strong>Datos del cultivo:</strong> Edad, densidad y superficie</li>
      <li><strong>Pr√°cticas agr√≠colas:</strong> Riego, suelo y fertilizaci√≥n</li>
    </ul>
  </div>

  <!-- FORMULARIO PRINCIPAL -->
  <form method="post" id="prediction-form" class="prediction-form" action="{% url 'nueva_prediccion' %}">
    {% csrf_token %}

    <!-- SECCI√ìN 1: Datos del Cultivo -->
    <div class="form-section animate-slide-in-up delay-2">
      <h2>Datos del Cultivo</h2>

      <div class="form-group animate-fade-in-left delay-1">
        <label for="id_tipo_arbol">Tipo de √Årbol <span style="color: red;">*</span></label>
        {{ form.tipo_arbol }}
        {% if form.tipo_arbol.errors %}
          <div class="form-error">{{ form.tipo_arbol.errors|first }}</div>
        {% endif %}
      </div>

      <div class="form-group animate-fade-in-left delay-2">
        <label for="id_comuna">Comuna <span style="color: red;">*</span></label>
        {{ form.comuna }}
        {% if form.comuna.errors %}
          <div class="form-error">{{ form.comuna.errors|first }}</div>
        {% endif %}
      </div>

      <div class="form-group animate-fade-in-left delay-3">
        <label for="id_hectareas">Hect√°reas <span style="color: red;">*</span></label>
        {{ form.hectareas }}
        {% if form.hectareas.errors %}
          <div class="form-error">{{ form.hectareas.errors|first }}</div>
        {% endif %}
      </div>

    </div>

    <!-- SECCI√ìN 2: Informaci√≥n de los √Årboles -->
    <div class="form-section animate-slide-in-up delay-3">
      <h2>Informaci√≥n de los √Årboles</h2>

      <div class="form-group animate-fade-in-left delay-4">
        <label for="id_edad_arboles">Edad de los √Årboles (a√±os) <span style="color: red;">*</span></label>
        {{ form.edad_arboles }}
        {% if form.edad_arboles.errors %}
          <div class="form-error">{{ form.edad_arboles.errors|first }}</div>
        {% endif %}
      </div>

      <div class="form-group animate-fade-in-left delay-5">
        <label for="id_densidad_plantacion">Densidad de Plantaci√≥n (√°rboles/ha)</label>
        {{ form.densidad_plantacion }}
      </div>

    </div>

    <!-- SECCI√ìN 3: Condiciones Agr√≠colas -->
    <div class="form-section animate-slide-in-up delay-4">
      <h2>Condiciones Agr√≠colas</h2>

      <div class="form-group animate-fade-in-left delay-6">
        <label for="id_tipo_riego">Tipo de Riego <span style="color: red;">*</span></label>
        {{ form.tipo_riego }}
      </div>

      <div class="form-group animate-fade-in-left delay-7">
        <label for="id_tipo_suelo">Tipo de Suelo <span style="color: red;">*</span></label>
        {{ form.tipo_suelo }}
      </div>

      <div class="form-group animate-fade-in-left delay-8">
        <label for="id_fertilizacion">Tipo de Fertilizaci√≥n</label>
        {{ form.fertilizacion }}
      </div>

    </div>

    <!-- Botones de acci√≥n -->
    <div class="form-actions animate-slide-in-up delay-5">
      <button type="submit" class="btn btn-primary btn-submit btn-lg" id="submit-btn">
        üå± Generar Predicci√≥n
      </button>
      <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-lg">
        ‚úï Cancelar
      </a>
    </div>

  </form>

</div>

<!-- Script para redirigir a loading con ID de predicci√≥n -->
<script>
document.getElementById('prediction-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const form = this;
  
  // Validar que el formulario sea v√°lido
  if (form.checkValidity() === false) {
    e.stopPropagation();
    form.classList.add('was-validated');
    return false;
  }
  
  // Enviar el formulario v√≠a AJAX
  const formData = new FormData(form);
  
  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
    }
  })
  .then(response => {
    // Si la respuesta es redireccionada, obtener la URL
    if (response.redirected) {
      // Extraer el ID de la predicci√≥n de la URL de redirecci√≥n
      const redirectUrl = response.url;
      const prediccionIdMatch = redirectUrl.match(/\/prediccion\/(\d+)\//);
      
      if (prediccionIdMatch) {
        const prediccionId = prediccionIdMatch[1];
        // Redirigir a loading con el ID
        window.location.href = '{% url "loading_prediccion" %}?prediccion_id=' + prediccionId;
      } else {
        // Si no encuentra ID, ir a loading sin par√°metro
        window.location.href = '{% url "loading_prediccion" %}';
      }
    } else if (response.ok || response.status === 201) {
      // Si es una respuesta normal (HTML)
      // Buscar la predicci√≥n m√°s reciente v√≠a otra ruta
      window.location.href = '{% url "loading_prediccion" %}';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // Si hay error, tambi√©n ir a loading
    window.location.href = '{% url "loading_prediccion" %}';
  });
});
</script>

{% endblock %}
